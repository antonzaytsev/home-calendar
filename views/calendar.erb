<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–º–∞—à–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</title>
    <link rel="stylesheet" href="/calendar.css">
</head>
<body>
    <div class="calendar-container">
        <div class="header">
            <div class="header-nav">
                <a href="/?date=<%= @prev_week_date %>" class="nav-button" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–Ω–∏: <%= @prev_week_date %>">‚Äπ –Ω–∞–∑–∞–¥</a>
                <a href="/" class="nav-button" title="–ù–∞ —Å–µ–≥–æ–¥–Ω—è" style="margin-left: 8px;">—Å–µ–≥–æ–¥–Ω—è</a>
            </div>
            <h1><%= [Date::MONTHNAMES[@week_dates.first.month], Date::MONTHNAMES[@week_dates.last.month]].uniq.join('-') %> <%= @week_dates.first.year %></h1>
            <div class="header-nav">
                <a href="/?date=<%= @next_week_date %>" class="nav-button" title="–°–ª–µ–¥—É—é—â–∏–µ –¥–Ω–∏: <%= @next_week_date %>">–≤–ø–µ—Ä–µ–¥ ‚Ä∫</a>
            </div>
        </div>

        <% if @error %>
        <div class="error"><%= @error %></div>
        <% end %>

        <div class="calendar-header">
            <div class="header-row">
                <div class="time-header"></div>
                <% @week_dates.each_with_index do |date, index| %>
                <div class="day-header <%= 'today' if date == @today %> <%= 'weekend' if date.wday == 0 || date.wday == 6 %>">
                    <div class="day-name"><%= Date::ABBR_DAYNAMES[date.wday].upcase %> <%= date.day %></div>
                </div>
                <% end %>
            </div>
        </div>

        <div class="calendar-body-wrapper">
            <div class="calendar-body">
                <div class="calendar-row">
                    <div class="time-column">
                        <% (0..23).each do |hour| %>
                        <div class="time-slot">
                            <%= format_hour(hour) %>
                        </div>
                        <% end %>
                    </div>

                <% @week_dates.each_with_index do |date, day_index| %>
                <div class="day-column">
                    <!-- Hour grid lines -->
                    <div class="hour-grid">
                        <% (0..23).each do |hour| %>
                        <div class="hour-line">
                            <div class="half-hour-line"></div>
                        </div>
                        <% end %>
                    </div>

                    <!-- Current time indicator (only show for today) -->
                    <% if date == @today %>
                    <div class="current-time-line" style="top: <%= @current_time_minutes %>px;"></div>
                    <% end %>

                    <!-- All-day events -->
                    <% if @week_events[date] %>
                        <% all_day_events = @week_events[date].select { |event| event['all_day'] } %>
                        <% all_day_events.each_with_index do |event, event_index| %>
                        <% is_past = event_is_past?(event, @today, @now) %>
                        <div class="event all-day-event<%= ' past-event' if is_past %>" style="top: <%= event_index * 22 %>px;">
                            <div class="event-title"><%= event['summary'] %></div>
                            <% if event['location'] && !event['location'].empty? %>
                            <div class="event-location">üìç <%= event['location'] %></div>
                            <% end %>
                        </div>
                        <% end %>
                    <% end %>

                    <!-- Timed events -->
                    <% if @week_events[date] %>
                        <% timed_events = @week_events[date].reject { |event| event['all_day'] } %>
                        <% event_columns = calculate_event_columns(timed_events) %>
                        <% timed_events.each do |event| %>
                        <% is_past = event_is_past?(event, @today, @now) %>
                        <% left_pos = event_left_position(event, event_columns) %>
                        <% width = event_width(event, event_columns) %>
                        <% style_attrs = "top: #{event_top_position(event)}px; height: #{event_height(event)}px; left: #{left_pos}%;" %>
                        <% style_attrs += " width: #{width}%;" if width %>
                        <div class="event<%= ' past-event' if is_past %>" style="<%= style_attrs %>">
                            <div class="event-title"><%= event['summary'] %></div>
                            <div class="event-time"><%= format_event_time(event) %></div>
                            <% if event['location'] && !event['location'].empty? %>
                            <div class="event-location">üìç <%= event['location'] %></div>
                            <% end %>
                        </div>
                        <% end %>
                    <% end %>
                </div>
                <% end %>
                </div>
            </div>
        </div>

        <div class="footer">
            –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <%= @now.strftime('%d.%m.%Y %H:%M') %> | –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
        </div>
    </div>

    <script src="/calendar.js"></script>
    <script>
        setCalendarConfig({
            currentTimeMinutes: <%= @current_time_minutes %>,
            pageRefreshMinutes: <%= PAGE_REFRESH_MINUTES %>,
            isTodayVisible: <%= @week_dates.include?(@today) %>
        });
    </script>
</body>
</html>
